use super::request::StreamId;
use super::types::*;
use serde::Deserialize;
use serde::Serialize;

#[derive(Serialize, Deserialize, Debug, Clone, PartialEq)]
pub struct VmServiceEvent {
    pub jsonrpc: String,
    pub method: String,
    pub params: VmServiceEventParams,
}

#[derive(Serialize, Deserialize, Debug, Clone, PartialEq)]
pub struct VmServiceEventParams {
    #[serde(rename = "streamId")]
    pub stream_id: StreamId,
    pub event: Event,
}

#[cfg(test)]
mod tests {
    use crate::io::request::StreamId;

    #[test]
    fn parse_timeline_event() {
        let json = r#"{"jsonrpc":"2.0","method":"streamNotify","params":{"streamId":"Timeline","event":{"type":"Event","kind":"TimelineEvents","vm":{"type":"@VM","name":"vm"},"timestamp":1709621862309,"timelineEvents":[{"name":"ProcessWeakHandles","cat":"GC","tid":32259,"pid":66406,"ts":145254162585,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"ProcessWeakTables","cat":"GC","tid":32259,"pid":66406,"ts":145254162585,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"ProcessWeakTables","cat":"GC","tid":32259,"pid":66406,"ts":145254162611,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"ProcessObjectIdTable","cat":"GC","tid":32259,"pid":66406,"ts":145254162611,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"ProcessObjectIdTable","cat":"GC","tid":32259,"pid":66406,"ts":145254162611,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"ProcessRememberedSet","cat":"GC","tid":32259,"pid":66406,"ts":145254162611,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"ProcessRememberedSet","cat":"GC","tid":32259,"pid":66406,"ts":145254162625,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"ParallelMark","cat":"GC","tid":32259,"pid":66406,"ts":145254162625,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"SweepExecutable","cat":"GC","tid":32259,"pid":66406,"ts":145254162629,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"SweepExecutable","cat":"GC","tid":32259,"pid":66406,"ts":145254162748,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"UpdateGrowthLimit","cat":"GC","tid":32259,"pid":66406,"ts":145254162754,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"UpdateGrowthLimit","cat":"GC","tid":32259,"pid":66406,"ts":145254162756,"ph":"E","args":{"Reason":"gc","Before.CombinedUsed (kB)":"44106","After.CombinedUsed (kB)":"40239","Hard Threshold (kB)":"9007199254740992","Soft Threshold (kB)":"183087","Idle Threshold (kB)":"41263","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"CollectOldGeneration","cat":"GC","tid":32259,"pid":66406,"ts":145254162759,"ph":"E","args":{"Reason":"finalize","Before.New.Used (kB)":"241","After.New.Used (kB)":"241","Before.Old.Used (kB)":"44106","After.Old.Used (kB)":"40239","Before.New.Capacity (kB)":"1024","After.New.Capacity (kB)":"1024","Before.Old.Capacity (kB)":"46672","After.Old.Capacity (kB)":"46672","Before.New.External (kB)":"0","After.New.External (kB)":"0","Before.Old.External (kB)":"0","After.Old.External (kB)":"0","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"PlatformChannel ScheduleHandler","cat":"Embedder","tid":32259,"pid":66406,"ts":145254211138,"ph":"b","id":"3","args":{"channel":"flutter/platform","isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"PlatformChannel ScheduleResult","cat":"Embedder","tid":32259,"pid":66406,"ts":145254234602,"ph":"b","id":"4","args":{"channel":"flutter/navigation","isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"PlatformChannel ScheduleResult","cat":"Embedder","tid":32259,"pid":66406,"ts":145254250384,"ph":"b","id":"5","args":{"channel":"flutter/navigation","isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"CollectNewGeneration","cat":"GC","tid":32259,"pid":66406,"ts":145254315846,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"Prologue","cat":"GC","tid":32259,"pid":66406,"ts":145254315846,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"Prologue","cat":"GC","tid":32259,"pid":66406,"ts":145254315847,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"ParallelScavenge","cat":"GC","tid":32259,"pid":66406,"ts":145254315857,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"IterateIsolateRoots","cat":"GC","tid":32259,"pid":66406,"ts":145254315858,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"IterateIsolateRoots","cat":"GC","tid":32259,"pid":66406,"ts":145254315958,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"IterateObjectIdTable","cat":"GC","tid":32259,"pid":66406,"ts":145254315958,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"IterateObjectIdTable","cat":"GC","tid":32259,"pid":66406,"ts":145254315967,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"IterateStoreBuffers","cat":"GC","tid":32259,"pid":66406,"ts":145254315967,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"IterateStoreBuffers","cat":"GC","tid":32259,"pid":66406,"ts":145254316247,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"IterateRememberedCards","cat":"GC","tid":32259,"pid":66406,"ts":145254316248,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"IterateRememberedCards","cat":"GC","tid":32259,"pid":66406,"ts":145254316302,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"ParallelScavenge","cat":"GC","tid":32259,"pid":66406,"ts":145254316858,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"Epilogue","cat":"GC","tid":32259,"pid":66406,"ts":145254316864,"ph":"B","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"Epilogue","cat":"GC","tid":32259,"pid":66406,"ts":145254316864,"ph":"E","args":{"isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"CollectNewGeneration","cat":"GC","tid":32259,"pid":66406,"ts":145254316868,"ph":"E","args":{"Reason":"new space","Before.New.Used (kB)":"2047","After.New.Used (kB)":"456","Before.Old.Used (kB)":"54271","After.Old.Used (kB)":"54500","Before.New.Capacity (kB)":"2048","After.New.Capacity (kB)":"1024","Before.Old.Capacity (kB)":"57920","After.Old.Capacity (kB)":"57920","Before.New.External (kB)":"0","After.New.External (kB)":"0","Before.Old.External (kB)":"0","After.Old.External (kB)":"0","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"BUILD","cat":"Dart","tid":32259,"pid":66406,"ts":145254368013,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"DartIsolate::HandleMessage","cat":"Embedder","tid":32259,"pid":66406,"ts":145254368270,"ph":"E","args":{}},{"name":"DartIsolate::HandleMessage","cat":"Embedder","tid":32259,"pid":66406,"ts":145254370540,"ph":"B","args":{}},{"name":"Frame","cat":"Dart","tid":32259,"pid":66406,"ts":145254370761,"ph":"b","id":"cbd89c7876eb5732","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"Animate","cat":"Dart","tid":32259,"pid":66406,"ts":145254371071,"ph":"b","id":"cbd89c7876eb5732","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"DartIsolate::HandleMessage","cat":"Embedder","tid":32259,"pid":66406,"ts":145254371216,"ph":"E","args":{}},{"name":"DartIsolate::HandleMessage","cat":"Embedder","tid":32259,"pid":66406,"ts":145254371224,"ph":"B","args":{}},{"name":"Animate","cat":"Dart","tid":32259,"pid":66406,"ts":145254371573,"ph":"e","id":"cbd89c7876eb5732","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"BUILD","cat":"Dart","tid":32259,"pid":66406,"ts":145254371965,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"BUILD","cat":"Dart","tid":32259,"pid":66406,"ts":145254374750,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"LAYOUT (root)","cat":"Dart","tid":32259,"pid":66406,"ts":145254375116,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"LAYOUT","cat":"Dart","tid":32259,"pid":66406,"ts":145254375183,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"AssetManager::GetAsMapping","cat":"Embedder","tid":32259,"pid":66406,"ts":145254405996,"ph":"B","args":{"name":"fonts/MaterialIcons-Regular.otf","isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"fml::OpenFile","cat":"Embedder","tid":32259,"pid":66406,"ts":145254405998,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"fml::OpenFile","cat":"Embedder","tid":32259,"pid":66406,"ts":145254406062,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"AssetManager::GetAsMapping","cat":"Embedder","tid":32259,"pid":66406,"ts":145254406100,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"LAYOUT","cat":"Dart","tid":32259,"pid":66406,"ts":145254408767,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"LAYOUT (root)","cat":"Dart","tid":32259,"pid":66406,"ts":145254408772,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"UPDATING COMPOSITING BITS (root)","cat":"Dart","tid":32259,"pid":66406,"ts":145254408889,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"UPDATING COMPOSITING BITS","cat":"Dart","tid":32259,"pid":66406,"ts":145254408905,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"UPDATING COMPOSITING BITS","cat":"Dart","tid":32259,"pid":66406,"ts":145254409323,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"UPDATING COMPOSITING BITS (root)","cat":"Dart","tid":32259,"pid":66406,"ts":145254409324,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"PAINT (root)","cat":"Dart","tid":32259,"pid":66406,"ts":145254409673,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"PAINT","cat":"Dart","tid":32259,"pid":66406,"ts":145254409722,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"PAINT","cat":"Dart","tid":32259,"pid":66406,"ts":145254431514,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"PAINT (root)","cat":"Dart","tid":32259,"pid":66406,"ts":145254431517,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"COMPOSITING","cat":"Dart","tid":32259,"pid":66406,"ts":145254431859,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"COMPOSITING","cat":"Dart","tid":32259,"pid":66406,"ts":145254436058,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"SEMANTICS (root)","cat":"Dart","tid":32259,"pid":66406,"ts":145254436221,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"SEMANTICS","cat":"Dart","tid":32259,"pid":66406,"ts":145254437032,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"Semantics.GetFragment","cat":"Dart","tid":32259,"pid":66406,"ts":145254437203,"ph":"B","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}},{"name":"Semantics.GetFragment","cat":"Dart","tid":32259,"pid":66406,"ts":145254440010,"ph":"E","args":{"isolateId":"isolates/3421855134667531","isolateGroupId":"isolateGroups/6453870140275210"}}]}}}"#;
        let value = serde_json::from_str::<super::VmServiceEvent>(json).unwrap();
        assert_eq!(value.method, "streamNotify".to_string());
    }

    #[test]
    fn parse_flutter_frame_event() {
        let json = r#"{"jsonrpc":"2.0","method":"streamNotify","params":{"streamId":"Extension","event":{"type":"Event","kind":"Extension","extensionKind":"Flutter.Frame","isolateGroup":{"type":"@IsolateGroup","id":"isolateGroups/6453870140275210","name":"main.dart","number":"6453870140275210","isSystemIsolateGroup":false},"isolate":{"type":"@Isolate","id":"isolates/3421855134667531","name":"main","number":"3421855134667531","isSystemIsolate":false,"isolateGroupId":"isolateGroups/6453870140275210"},"timestamp":1709621862365,"extensionData":{"number":4,"startTime":145254484111,"elapsed":11689,"build":1500,"raster":9367,"vsyncOverhead":776}}}}"#;
        let event = serde_json::from_str::<super::VmServiceEvent>(json).unwrap();
        assert_eq!(event.method, "streamNotify".to_string());
        assert_eq!(event.params.stream_id, StreamId::Extension);
        assert_eq!(
            event.params.event.extension_kind,
            Some("Flutter.Frame".to_string())
        );
    }

    #[test]
    fn parse_flutter_service_extension_state_changed() {
        let json = r#"{"jsonrpc":"2.0","method":"streamNotify","params":{"streamId":"Extension","event":{"type":"Event","kind":"Extension","extensionKind":"Flutter.ServiceExtensionStateChanged","isolateGroup":{"type":"@IsolateGroup","id":"isolateGroups/6453870140275210","name":"main.dart","number":"6453870140275210","isSystemIsolateGroup":false},"isolate":{"type":"@Isolate","id":"isolates/3421855134667531","name":"main","number":"3421855134667531","isSystemIsolate":false,"isolateGroupId":"isolateGroups/6453870140275210"},"timestamp":1709621862328,"extensionData":{"extension":"ext.flutter.activeDevToolsServerAddress","value":"http://127.0.0.1:52338"}}}}"#;
        let event = serde_json::from_str::<super::VmServiceEvent>(json).unwrap();
        assert_eq!(event.method, "streamNotify".to_string());
        assert_eq!(event.params.stream_id, StreamId::Extension);
        assert_eq!(
            event.params.event.extension_kind,
            Some("Flutter.ServiceExtensionStateChanged".to_string())
        );
    }
}
